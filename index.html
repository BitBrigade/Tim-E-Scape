<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
  </head>
  <body>
    <script>
      // Game config
      var config = {
        type: Phaser.AUTO, // sets type automatically to WEBGL; falls back to CANVAS if WEBGL is not supported
        width: 700,
        height: 600,

        // Game physics
        physics: {
          default: 'arcade', // physics system
          arcade: {
            //gravity: { y: 300 },
          },
        },
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
      }

      var game = new Phaser.Game(config)

      function preload() {
        this.load.image('background', 'assets/background.png')
        this.load.spritesheet('blob', 'assets/blob.png', {
          frameWidth: 24,
          frameHeight: 24,
        })
        this.load.image('portal', 'assets/portal.png')
        this.load.image('laser_blue_vert', 'assets/laser_blue_vert.png')
        this.load.image('laser_blue_horiz', 'assets/laser_blue_horiz.png')
        this.load.image('laser_violet_vert', 'assets/laser_violet_vert.png')
        this.load.image('laser_violet_horiz', 'assets/laser_violet_horiz.png')
        this.load.image('mine', 'assets/mine.png')
      }

      function create() {
        // Add the background image
        this.add.image(350, 300, 'background').setScale(1.6, 1.325)

        // Add the portal image
        this.portal = this.physics.add
          .image(350, 50, 'portal')
          .setImmovable(true)
          .setOrigin(0.5)

        // Create an invisible sprite that matches the size and position of the portal image
        this.portalCollider = this.physics.add
          .sprite(350, 50, null)
          .setImmovable(true)
          .setVisible(false)
        this.portalCollider.setSize(this.portal.width, this.portal.height)
        this.portalCollider.setPosition(this.portal.x, this.portal.y)

        // Create the player sprite
        this.player = this.physics.add.sprite(350, 550, 'blob')

        // Set the player's drag to control its movement
        this.player.setDrag(1000)

        // Set world bounds to the dimensions of the background image
        this.physics.world.setBounds(8, 8, 682, 582)

        // Set player body to collide with the world bounds
        this.player.setCollideWorldBounds(true)

        // Add a collider for the portal image
        this.physics.add.collider(this.player, this.portalCollider, () => {
          this.player.setVelocity(0)
          this.player.active = false // set player to inactive so it doesn't move anymore
          this.player.setPosition(this.portal.x, this.portal.y)
          this.player.setScale(0.5) // set the scale of the blob to half of its original size
          this.time.delayedCall(250, () => {
            this.player.setVisible(false)
          })
        })

        // Lasers
        this.lasers = this.physics.add.staticGroup()
        this.lasers.create(550, 250, 'laser_blue_vert')
        this.lasers.create(625, 240, 'laser_violet_horiz')

        this.lasers.create(485, 175, 'laser_blue_horiz')

        this.lasers.create(150, 250, 'laser_violet_vert')
        this.lasers.create(75, 240, 'laser_blue_horiz')
        
        this.lasers.create(350, 300, 'laser_violet_vert')

        this.lasers.create(240, 500, 'laser_violet_horiz')
        this.lasers.create(460, 500, 'laser_blue_horiz')

        this.lasers.create(350, 100, 'laser_blue_horiz')

        this.lasers.create(215, 175, 'laser_blue_horiz')

        this.lasers.create(285, 375, 'laser_blue_horiz')
        this.lasers.create(415, 375, 'laser_violet_horiz')

        this.physics.add.collider(this.player, this.lasers, () => {
          // Game over logic here
          window.alert('Game Over')
          this.scene.restart()
        })

        // Mine
        this.mines = this.physics.add.group()

        const mine1 = this.mines.create(50, 450, 'mine')
        mine1.setImmovable(false)
        mine1.setCollideWorldBounds(true)
        mine1.setBounce(1)
        mine1.setScale(1)

        const mine2 = this.mines.create(50, 130, 'mine')
        mine2.setImmovable(false)
        mine2.setCollideWorldBounds(true)
        mine2.setBounce(1)
        mine2.setScale(1)
        // Timer Bar
      }

      function update() {
        // Player Movements
        const cursors = this.input.keyboard.createCursorKeys()

        if (this.player.active) {
          if (cursors.left.isDown) {
            this.player.setVelocityX(-200)
          } else if (cursors.right.isDown) {
            this.player.setVelocityX(200)
          } else {
            this.player.setVelocityX(0)
          }

          if (cursors.up.isDown) {
            this.player.setVelocityY(-200)
          } else if (cursors.down.isDown) {
            this.player.setVelocityY(200)
          } else {
            this.player.setVelocityY(0)
          }
        }

        this.mines.getChildren()[0].setVelocityX(200);
        this.mines.getChildren()[1].setVelocityX(150);

      }
    </script>
  </body>
</html>
